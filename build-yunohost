#!/bin/bash
# Usage ./build-yunohost [ARCH [DIST [DEB_DIST]]]
# ARCH amd64|i386
# DIST stable|testing
# DEB_DIST jessie|stretch

DEFAULT_DEB_DIST="jessie"

# Build Yunohost iso for amd64 or i386 arch
# Usage: build ARCH
function build
{
    local ARCH="$1"
    REPO_URL="http://repo.yunohost.org/debian/"
    if [ "$DIST" = "testing" ] ; then
        sed -i "s#$REPO_URL jessie stable#$REPO_URL $DEB_DIST stable testing#" profiles/*.preseed
        sed -i "s#$REPO_URL stretch stable#$REPO_URL $DEB_DIST stable testing#" profiles/*.preseed
    else
        sed -i "s#$REPO_URL jessie stable testing#$REPO_URL $DEB_DIST stable#" profiles/*.preseed
        sed -i "s#$REPO_URL stretch stable testing#$REPO_URL $DEB_DIST stable#" profiles/*.preseed
    fi
    build-simple-cdd --dist $DEB_DIST --conf ./simple-cdd-$ARCH.conf

    # Find the release version of debian
    DEBNUM="$(grep "Version:" tmp/${DEB_DIST}_Release | awk '{print $2;}')"

    # Find the release version of YunoHost
    wget ${REPO_URL}dists/${DEB_DIST}/${DIST}/binary-i386/Packages.gz
    gunzip Packages.gz
    YNH_VERSION=$(grep "^Package: yunohost$" --after-context=1 Packages | grep "Version" | awk '{print $2;}')
    rm Packages

    rm -f images/yunohost-$DEB_DIST-$YNH_VERSION-$ARCH-$DIST.iso
    $(pwd)/add-firmware-to images/debian-$DEBNUM-$ARCH-CD-1.iso images/yunohost-$DEB_DIST-$YNH_VERSION-$ARCH-$DIST.iso $DEB_DIST
    rm images/debian-$DEBNUM-$ARCH-CD-1.iso
    rm images/debian-$DEBNUM-$ARCH-CD-1.list.gz
}

# Sign the new iso
# Usage: sign ARCH
function sign
{
    local ARCH="$1"
    NAME="images/yunohost-$DEB_DIST-$YNH_VERSION-$ARCH-$DIST.iso"
    gpg --output $NAME.sig --detach-sig $NAME
    sha256sum $NAME > $NAME.sum
}

function build_and_sign
{
    rm -r $(pwd)/tmp

    local ARCH="$1"
    build $ARCH
    sign $ARCH
}

DIST="${2:-stable}"
DEB_DIST="${3:-$DEFAULT_DEB_DIST}"

if [ -z "$1" ]
then
    build_and_sign i386
    build_and_sign amd64
else
    build_and_sign $1
fi
